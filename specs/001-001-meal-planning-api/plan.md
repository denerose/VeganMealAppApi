# Implementation Plan: Vegan Meal Planning API

**Branch**: `001-001-meal-planning-api` | **Date**: 2025-01-06 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-001-meal-planning-api/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command. Research, data model, contracts, and quickstart guide are complete.

## Summary

Build a RESTful API for vegan meal planning that enables users to:
1. Plan weekly meals (lunch/dinner) from a personal meal library
2. Manage a tenant-scoped meal library with quality-based filtering
3. Auto-populate lunches with leftovers from dinners
4. Configure weekly preferences for meal selection

**Technical Approach**: Clean Architecture with domain-driven design using Bun runtime, TypeScript 5.3+, Prisma ORM for PostgreSQL 16, date-fns for date manipulation, and OpenAPI 3.0 specification. Multi-tenant architecture with row-level isolation via tenantId foreign keys.

## Technical Context

**Language/Version**: TypeScript 5.3+ (strict mode, ESNext target, bundler module resolution)  
**Primary Dependencies**: Bun 1.2.3+ (runtime), Prisma 5.x (ORM), date-fns 3.5+ (date library), ESLint 8.x + Prettier 3.x (code quality)  
**Storage**: PostgreSQL 16 with row-level multi-tenancy isolation  
**Testing**: Bun's built-in test runner with 80%+ unit test coverage requirement  
**Target Platform**: Linux/macOS server (Node.js compatible via Bun)  
**Project Type**: Single backend API project (RESTful web service)  
**Performance Goals**: <200ms P95 API response latency, 1000+ concurrent requests with <10% degradation  
**Constraints**: <200ms P95 latency, efficient database queries with indexes, no N+1 queries  
**Scale/Scope**: Multi-tenant SaaS, 100+ tenants, 10k+ meals per tenant, 52 planned weeks per tenant/year

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Pre-Research Check (Phase 0)

| Principle | Status | Notes |
|-----------|--------|-------|
| **Code Quality** | ✅ PASS | TypeScript strict mode + ESLint + Prettier enforce quality standards |
| **Clean Architecture** | ✅ PASS | Domain → Application → Infrastructure layers, interface boundaries |
| **Test-First** | ✅ PASS | Bun test runner configured, 80% coverage gate enforced |
| **Modular Code & DI** | ✅ PASS | Constructor injection, repository pattern, interface-based dependencies |
| **Performance** | ✅ PASS | <200ms P95 requirement, database indexes, query optimization |
| **Domain Driven Design** | ✅ PASS | Ubiquitous language (PlannedWeek, DayPlan, Meal, MealQualities), aggregates, value objects, repositories |
| **Vegan-First** | ✅ PASS | All examples use vegan meals (tofu scramble, cashew alfredo, lentil curry) |

**Decision**: ✅ **PROCEED TO PHASE 0 RESEARCH**

### Post-Design Check (Phase 1)

| Principle | Status | Notes |
|-----------|--------|-------|
| **Code Quality** | ✅ PASS | Data model uses meaningful names, single responsibility per entity |
| **Clean Architecture** | ✅ PASS | Prisma schema is infrastructure layer, domain models separate |
| **Test-First** | ✅ PASS | Test structure defined in research.md (unit → integration → API) |
| **Modular Code & DI** | ✅ PASS | Repository interfaces defined for Meal, PlannedWeek, Ingredient |
| **Performance** | ✅ PASS | Strategic indexes on tenantId, composite indexes, date ranges |
| **Domain Driven Design** | ✅ PASS | Aggregates (PlannedWeek root with DayPlans), value objects (MealQualities, enums), repositories |
| **Vegan-First** | ✅ PASS | Sample data in data-model.md uses cashew cream, tofu, nutritional yeast |

**Decision**: ✅ **PROCEED TO PHASE 2 TASKS**

## Project Structure

### Documentation (this feature)

```text
specs/001-001-meal-planning-api/
├── spec.md              # Feature specification (4 user stories, 30 FRs, 9 success criteria) ✅
├── plan.md              # This file (implementation plan) ✅
├── research.md          # Technology research & architectural decisions ✅
├── data-model.md        # Complete Prisma schema with 10 models ✅
├── quickstart.md        # Developer onboarding guide ✅
├── contracts/           # API contracts ✅
│   └── openapi.yaml     # OpenAPI 3.0 specification for Postman
├── checklists/          # Quality validation ✅
│   └── requirements.md  # Specification checklist (all passed)
└── tasks.md             # Phase 2 breakdown (NOT created yet - use /speckit.tasks command)
```

### Source Code (repository root)

```text
# Single backend API project structure
src/
├── domain/                      # Business entities & logic (no infrastructure dependencies)
│   ├── meal/
│   │   ├── meal.entity.ts       # Meal aggregate root
│   │   ├── meal-qualities.vo.ts # MealQualities value object
│   │   ├── meal.repository.ts   # Repository interface (abstract)
│   │   └── meal.spec.ts         # Unit tests
│   ├── planned-week/
│   │   ├── planned-week.entity.ts   # PlannedWeek aggregate root
│   │   ├── day-plan.entity.ts       # DayPlan entity (part of aggregate)
│   │   ├── planned-week.repository.ts # Repository interface
│   │   └── planned-week.spec.ts
│   ├── ingredient/
│   │   ├── ingredient.entity.ts
│   │   ├── storage-type.enum.ts # FRIDGE/PANTRY/FROZEN/OTHER
│   │   ├── ingredient.repository.ts
│   │   └── ingredient.spec.ts
│   ├── user/
│   │   ├── user.entity.ts
│   │   ├── user-settings.entity.ts
│   │   ├── user.repository.ts
│   │   └── user.spec.ts
│   └── shared/
│       ├── day-of-week.enum.ts  # MONDAY, TUESDAY, etc.
│       ├── week-start-day.enum.ts # MONDAY/SATURDAY/SUNDAY
│       └── result.ts             # Result<T, E> type for error handling
│
├── application/                  # Use cases & application services
│   ├── meal/
│   │   ├── create-meal.usecase.ts
│   │   ├── update-meal.usecase.ts
│   │   ├── archive-meal.usecase.ts
│   │   ├── get-eligible-meals.usecase.ts  # Quality-based filtering
│   │   ├── get-random-meal.usecase.ts     # Random eligible selection
│   │   └── list-meals.usecase.ts
│   ├── planned-week/
│   │   ├── create-planned-week.usecase.ts
│   │   ├── populate-leftovers.usecase.ts  # Auto-populate logic
│   │   ├── assign-meal-to-day.usecase.ts
│   │   └── get-planned-week.usecase.ts
│   ├── ingredient/
│   │   ├── create-ingredient.usecase.ts
│   │   ├── update-ingredient.usecase.ts
│   │   └── delete-ingredient.usecase.ts
│   ├── user-settings/
│   │   ├── get-user-settings.usecase.ts
│   │   └── update-user-settings.usecase.ts # Admin only
│   └── shared/
│       ├── interfaces/
│       │   └── date-service.interface.ts  # Abstraction for date-fns
│       └── dtos/                          # Data transfer objects
│
├── infrastructure/               # External concerns (frameworks, DB, HTTP)
│   ├── database/
│   │   ├── prisma/
│   │   │   ├── schema.prisma           # Database schema (10 models, 5 enums)
│   │   │   ├── migrations/             # Migration history
│   │   │   └── seed.ts                 # Sample vegan meal data
│   │   ├── repositories/
│   │   │   ├── prisma-meal.repository.ts      # Concrete Prisma implementation
│   │   │   ├── prisma-planned-week.repository.ts
│   │   │   ├── prisma-ingredient.repository.ts
│   │   │   └── prisma-user.repository.ts
│   │   └── mappers/                    # Entity ↔ Prisma model mapping
│   │       ├── meal.mapper.ts
│   │       ├── planned-week.mapper.ts
│   │       └── ingredient.mapper.ts
│   ├── http/
│   │   ├── controllers/
│   │   │   ├── meal.controller.ts
│   │   │   ├── planned-week.controller.ts
│   │   │   ├── day-plan.controller.ts
│   │   │   ├── ingredient.controller.ts
│   │   │   ├── user-settings.controller.ts
│   │   │   └── health.controller.ts
│   │   ├── middleware/
│   │   │   ├── auth.middleware.ts      # JWT validation
│   │   │   ├── tenant-isolation.middleware.ts  # Inject tenantId from token
│   │   │   ├── error-handler.middleware.ts
│   │   │   └── validation.middleware.ts
│   │   ├── routes/
│   │   │   └── index.ts                # Route registration
│   │   └── dtos/                       # Request/Response DTOs
│   │       ├── meal.dto.ts
│   │       ├── planned-week.dto.ts
│   │       └── user-settings.dto.ts
│   ├── config/
│   │   ├── database.config.ts
│   │   ├── jwt.config.ts
│   │   └── env.config.ts               # Environment variable validation
│   ├── services/
│   │   ├── date-fns.service.ts         # Concrete date-fns implementation
│   │   └── jwt.service.ts              # Token generation/verification
│   └── di/
│       └── container.ts                # Dependency injection composition root
│
└── index.ts                            # Application entry point

tests/
├── unit/                               # Fast, isolated tests (80% coverage target)
│   ├── domain/
│   │   ├── meal/
│   │   ├── planned-week/
│   │   └── ingredient/
│   └── application/
│       ├── meal/
│       └── planned-week/
├── integration/                        # Database integration tests (15%)
│   ├── repositories/
│   └── usecases/
└── e2e/                               # API endpoint tests (5%)
    ├── meal.e2e.spec.ts
    ├── planned-week.e2e.spec.ts
    └── user-settings.e2e.spec.ts

docker-compose.yml                     # PostgreSQL 16 container
.env.example                           # Environment template
tsconfig.json                          # TypeScript config (strict, ESNext, bundler)
.eslintrc.json                         # ESLint rules
.prettierrc                            # Prettier formatting
package.json                           # Dependencies & scripts
bun.lockb                              # Bun lockfile
README.md                              # Project overview
```

**Structure Decision**: Single backend API project using Clean Architecture with three layers: **Domain** (business entities, no dependencies), **Application** (use cases, depends on domain), **Infrastructure** (Prisma, HTTP, depends on both). This structure enforces dependency inversion, enables isolated testing, and keeps business logic independent of frameworks. Domain models use ubiquitous language from specification (PlannedWeek, DayPlan, Meal, MealQualities, Ingredient).

## Complexity Tracking

> **No violations detected** - all constitution principles satisfied without exceptions.

Clean Architecture, DDD, and repository pattern are justified by:
- **Business logic isolation**: Meal eligibility filtering, leftover logic must be testable without database
- **Multi-tenancy requirements**: Row-level isolation and tenant context injection require abstraction
- **Technology flexibility**: Prisma ORM can be replaced without changing business logic
- **Testability**: 80% unit test coverage impossible with coupled infrastructure

All complexity serves constitution compliance rather than violating it.
