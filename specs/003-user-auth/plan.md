# Implementation Plan: User Authentication and Registration

**Branch**: `003-user-auth` | **Date**: 13 February 2026 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-user-auth/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command. Research, data model, contracts, and quickstart guide are complete.

## Summary

Implement user authentication and registration system with email/password authentication for development, designed with extensible architecture to support future authentication methods (OAuth, social auth, passkeys). The system provides user registration, login, password management (change/reset), profile management, and JWT-based token authentication with multi-tenant isolation.

**Technical Approach**: Clean Architecture with extensible authentication strategy pattern. Email/password authentication implemented first using bcrypt for password hashing and JWT for tokens. Architecture designed with `AuthProvider` interface to enable future OAuth, social auth, and passkey implementations without modifying core authentication flow. Rate limiting, token expiration (24h), and password reset tokens (1h) implemented per specification.

## Technical Context

**Language/Version**: TypeScript 5.3+ (strict mode, ESNext target, bundler module resolution)  
**Primary Dependencies**: Bun 1.2.3+ (runtime), Prisma 7.x (ORM), bcrypt (password hashing), jsonwebtoken (JWT), nodemailer (email delivery), rate-limiter-flexible (rate limiting), ESLint 8.x + Prettier 3.x (code quality)  
**Storage**: PostgreSQL 16 with row-level multi-tenancy isolation  
**Testing**: Bun's built-in test runner with 80%+ unit test coverage requirement  
**Target Platform**: Linux/macOS server (Node.js compatible via Bun)  
**Project Type**: Single backend API project (RESTful web service)  
**Performance Goals**: <200ms P95 API response latency, 1000+ concurrent authentication requests with <10% degradation  
**Constraints**: <200ms P95 latency, efficient database queries with indexes, rate limiting (3 attempts per 10 minutes per IP), token expiration (24h), password reset token expiration (1h)  
**Scale/Scope**: Multi-tenant SaaS, 100+ tenants, 10k+ users, authentication events logged for security monitoring

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Pre-Research Check (Phase 0)

| Principle | Status | Notes |
|-----------|--------|-------|
| **Code Quality** | ✅ PASS | TypeScript strict mode + ESLint + Prettier enforce quality standards |
| **Clean Architecture** | ✅ PASS | Domain entities (User, AuthToken) independent of infrastructure; use cases depend on domain only |
| **Simple Regression Testing** | ✅ PASS | Test-first development with Bun test runner; unit tests for auth logic isolated from infrastructure |
| **Modular Code & DI** | ✅ PASS | Constructor injection via DI container; AuthProvider interface enables extensibility |
| **Performance Requirements** | ✅ PASS | Rate limiting prevents brute force; JWT validation optimized; password hashing async |
| **Domain Driven Design** | ✅ PASS | User, Tenant entities use ubiquitous language; authentication domain concepts modeled explicitly |
| **Vegan-First Testing** | ✅ PASS | Test data uses vegan examples (e.g., "vegan-chef@example.com") |

### Post-Design Check (Phase 1)

| Principle | Status | Notes |
|-----------|--------|-------|
| **Code Quality** | ✅ PASS | All code follows existing patterns; interfaces defined for extensibility |
| **Clean Architecture** | ✅ PASS | AuthProvider strategy pattern keeps domain independent; repositories abstract database |
| **Simple Regression Testing** | ✅ PASS | Auth use cases testable in isolation; mocks for email service and rate limiter |
| **Modular Code & DI** | ✅ PASS | AuthProvider implementations registered via DI; dependencies explicit in constructors |
| **Performance Requirements** | ✅ PASS | Rate limiting configured; JWT validation efficient; password hashing uses bcrypt (async) |
| **Domain Driven Design** | ✅ PASS | Authentication domain concepts (User, AuthToken, PasswordResetToken) modeled explicitly |
| **Vegan-First Testing** | ✅ PASS | Test examples use vegan-themed data |

## Project Structure

### Documentation (this feature)

```text
specs/003-user-auth/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
│   └── openapi.yaml     # OpenAPI 3.0 specification
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
src/
├── domain/
│   └── auth/                           # NEW: Authentication domain
│       ├── auth-provider.interface.ts  # Strategy interface for extensible auth
│       ├── auth-token.entity.ts        # JWT token domain model
│       ├── password-reset-token.entity.ts # Password reset token domain model
│       ├── user-credentials.entity.ts  # User credentials (email/password)
│       └── auth.repository.ts          # Authentication repository interface
│   └── user/                           # EXISTING: User domain (extended)
│       ├── user.entity.ts              # Extended with password hash field
│       └── user.repository.ts          # Extended with password methods
├── application/
│   └── auth/                           # NEW: Authentication use cases
│       ├── register-user.use-case.ts   # User registration
│       ├── authenticate-user.use-case.ts # Login (email/password)
│       ├── change-password.use-case.ts # Password change
│       ├── request-password-reset.use-case.ts # Password reset request
│       ├── reset-password.use-case.ts  # Password reset completion
│       ├── get-user-profile.use-case.ts # Get user profile
│       └── update-user-profile.use-case.ts # Update profile (nickname)
├── infrastructure/
│   ├── auth/                           # NEW: Authentication infrastructure
│   │   ├── providers/
│   │   │   └── email-password-auth.provider.ts # Email/password implementation
│   │   ├── jwt/
│   │   │   ├── jwt-generator.ts        # JWT token generation
│   │   │   └── jwt-validator.ts        # JWT token validation
│   │   ├── password/
│   │   │   └── bcrypt-password-hasher.ts # Password hashing with bcrypt
│   │   ├── rate-limiting/
│   │   │   └── rate-limiter.service.ts # Rate limiting service
│   │   └── email/
│   │       └── email.service.ts        # Email delivery service
│   ├── database/
│   │   └── repositories/
│   │       ├── prisma-auth.repository.ts # NEW: Auth repository implementation
│   │       └── prisma-user.repository.ts # EXTENDED: Password methods added
│   ├── http/
│   │   ├── controllers/
│   │   │   └── auth.controller.ts      # NEW: Auth endpoints controller
│   │   ├── middleware/
│   │   │   ├── auth.middleware.ts      # UPDATED: JWT validation
│   │   │   └── rate-limit.middleware.ts # NEW: Rate limiting middleware
│   │   └── routes/
│   │       └── index.ts                # EXTENDED: Auth routes added
│   └── di/
│       └── setup.ts                    # EXTENDED: Auth dependencies registered
└── prisma/
    └── migrations/                     # NEW: Auth schema migrations
        └── [timestamp]_add_auth_tables/
            └── migration.sql            # Password hash, reset tokens

tests/
├── unit/                               # Unit tests (80% coverage)
│   ├── domain/
│   │   └── auth/                       # NEW: Auth domain tests
│   └── application/
│       └── auth/                       # NEW: Auth use case tests
├── integration/                        # Integration tests (15%)
│   ├── repositories/
│   │   └── auth.repository.integration.spec.ts # NEW: Auth repository tests
│   └── infrastructure/
│       └── auth/                       # NEW: Auth infrastructure tests
└── e2e/                               # API endpoint tests (5%)
    └── auth.e2e.spec.ts               # NEW: Auth API tests

prisma/
└── schema.prisma                       # EXTENDED: Auth fields added
```

**Structure Decision**: Single backend API project using Clean Architecture with extensible authentication strategy pattern. **Domain layer** defines `AuthProvider` interface enabling future OAuth/social/passkey implementations. **Application layer** contains use cases that depend on `AuthProvider` interface, not concrete implementations. **Infrastructure layer** implements email/password provider and can add OAuth/social/passkey providers later. This structure enforces dependency inversion, enables isolated testing, and keeps authentication logic independent of specific auth methods. Domain models use ubiquitous language (User, AuthToken, PasswordResetToken).

## Complexity Tracking

> **No violations detected** - all constitution principles satisfied without exceptions.

Extensible authentication architecture (strategy pattern) is justified by:
- **Future extensibility requirement**: User explicitly requested support for OAuth, social auth, and passkeys later
- **Clean Architecture compliance**: `AuthProvider` interface keeps domain independent of infrastructure
- **Testability**: Use cases testable with mock auth providers without real implementations
- **Single Responsibility**: Each auth provider implementation handles one authentication method
- **Open/Closed Principle**: New auth methods can be added without modifying existing code

All complexity serves constitution compliance and explicit user requirements rather than violating principles.
